name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  e2e:
    runs-on: macos-26
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      # ── Phase 1: Build & Unit Tests ────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: |
          set -euo pipefail
          go build -o pv .
          sudo cp pv /usr/local/bin/pv

      - name: Unit tests
        run: go test ./...

      # ── Phase 2: Install + Multi-PHP Setup ─────────────────────────
      - name: Install pv with PHP 8.4 and 8.3
        timeout-minutes: 5
        run: scripts/e2e/install.sh

      # ── Phase 3: Verify Installation ───────────────────────────────
      - name: Verify both PHP versions installed
        timeout-minutes: 1
        run: scripts/e2e/verify-install.sh

      # ── Phase 4: Create Fixtures ───────────────────────────────────
      - name: Create test fixtures
        run: scripts/e2e/fixtures.sh

      # ── Phase 5: Link & Verify ─────────────────────────────────────
      - name: Link projects and verify config
        run: scripts/e2e/link-verify.sh

      # ── Phase 6: Start & Curl All Sites ────────────────────────────
      - name: Start server and curl all sites
        timeout-minutes: 2
        run: scripts/e2e/start-curl.sh

      # ── Phase 7: Dynamic Link While Running ────────────────────────
      - name: Dynamic link while server running
        timeout-minutes: 1
        run: scripts/e2e/dynamic-link.sh

      # ── Phase 8: Dynamic Unlink While Running ──────────────────────
      - name: Dynamic unlink while server running
        timeout-minutes: 1
        run: scripts/e2e/dynamic-unlink.sh

      # ── Phase 9: Test pv log ───────────────────────────────────────
      - name: Test pv log
        run: scripts/e2e/log.sh

      # ── Phase 10: Test pv restart ──────────────────────────────────
      - name: Test pv restart
        timeout-minutes: 1
        run: scripts/e2e/restart.sh

      # ── Phase 11: PHP Shim Resolution ──────────────────────────────
      - name: Test PHP shim per-project resolution
        run: scripts/e2e/shim.sh

      # ── Phase 12: Error Handling ───────────────────────────────────
      - name: Test error handling
        run: scripts/e2e/errors.sh

      # ── Phase 13: Stop Server ──────────────────────────────────────
      - name: Stop server
        run: scripts/e2e/stop.sh

      # ── Phase 14: PHP Version Lifecycle ────────────────────────────
      - name: Test PHP version lifecycle
        run: scripts/e2e/lifecycle.sh

      # ── Phase 15: Test pv update ───────────────────────────────────
      - name: Test pv update
        timeout-minutes: 3
        run: scripts/e2e/update.sh

      # ── Phase 16: Verify Server After PHP Changes ──────────────────
      - name: Verify server with remaining projects
        timeout-minutes: 2
        run: scripts/e2e/verify-final.sh

      # ── Phase 17: Failure Diagnostics & Cleanup ────────────────────
      - name: Dump logs on failure
        if: failure()
        run: scripts/e2e/diagnostics.sh

      - name: Cleanup
        if: always()
        run: sudo -E pv stop 2>/dev/null || true
